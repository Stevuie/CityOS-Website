<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CityOS Parking</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='clientside.css') }}"
    />
  </head>
  <body class="cityos-body">
    <div id="root"></div>

    {% raw %}
    <script type="text/babel">
      const { useState } = React;

      function App() {
        const [currentPage, setCurrentPage] = useState("about");
        const [spot, setSpot] = useState("spot_1");
        const [day, setDay] = useState("Monday");
        const [time, setTime] = useState("");
        const [timeMode, setTimeMode] = useState("manual");
        const [predictionResult, setPredictionResult] = useState(null);
        const [showResult, setShowResult] = useState(false);

        const commonTimes = [
          "07:00",
          "08:00",
          "09:00",
          "10:00",
          "12:00",
          "14:00",
          "16:00",
          "18:00",
          "20:00",
          "22:00",
        ];

        const handlePrediction = async () => {
          if (!time.trim()) {
            alert("Please enter a time");
            return;
          }

          const [hour, minute] = time.split(":");

          try {
            const response = await fetch("/predict", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                spot_id: spot,
                day: day,
                hour: hour,
                minute: minute,
              }),
            });

            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();
            setPredictionResult(data.status);
            setShowResult(true);

            // Reset animation
            setTimeout(() => setShowResult(false), 0);
            setTimeout(() => setShowResult(true), 10);
          } catch (error) {
            console.error("Prediction error:", error);
            alert(
              "Error getting prediction. Please make sure the ML server is running."
            );
          }
        };

        const Header = () => (
          <header className="cityos-header">
            <div className="cityos-header-container">
              <div className="cityos-header-flex">
                <div className="cityos-header-logo-group">
                  <svg
                    className="cityos-logo"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
                    <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1V8a1 1 0 00-1-1h-3z" />
                  </svg>
                  <h1 className="cityos-header-title">
                    <span className="italic-text">City</span>OS Parking
                  </h1>
                </div>
                <nav className="cityos-header-nav">
                  <button
                    onClick={() => setCurrentPage("about")}
                    className={`cityos-btn cityos-btn-nav${
                      currentPage === "about" ? " cityos-btn-nav-active" : ""
                    }`}
                  >
                    About Us
                  </button>
                  <button
                    onClick={() => setCurrentPage("predictor")}
                    className={`cityos-btn cityos-btn-nav${
                      currentPage === "predictor"
                        ? " cityos-btn-nav-active"
                        : ""
                    }`}
                  >
                    Parking Predictor
                  </button>
                  <button
                    onClick={() => setCurrentPage("map")}
                    className={`cityos-btn cityos-btn-nav${
                      currentPage === "map" ? " cityos-btn-nav-active" : ""
                    }`}
                  >
                    Map Interface
                  </button>
                </nav>
              </div>
            </div>
          </header>
        );

        const AboutPage = () => (
          <div className="cityos-main">
            <section className="cityos-hero">
              <div className="cityos-hero-center">
                <h1 className="cityos-hero-title">
                  Intelligent Parking for{" "}
                  <span className="cityos-highlight">Smarter Cities</span>
                </h1>
              </div>
            </section>
            <section className="cityos-team">
              <div className="cityos-team-container">
                <h2 className="cityos-team-title">Mission Statement</h2>
                <p className="cityos-hero-desc">
                  <p className="paragraph-text">
                    <span className="italic-text">City</span>OS is a project
                    organized and developed under the guidance of Dr. Jorge
                    Ortiz at WINLAB, Rutgers University. Our key mission is to
                    leverage computer vision and machine learning algorithms to
                    create a smart parking system that predicts parking
                    availability, reduces congestion and improves urban quality
                    of life.
                  </p>
                  <p className="paragraph-text">
                    This website serves as documentation of our creative
                    processes, technical endeavors, and real-world applications
                    for how our design could be feasibly used.
                  </p>
                </p>
                <h2 className="cityos-team-title">Our Team</h2>
                <div className="cityos-team-grid">
                  {[
                    {
                      name: "Aryan Upadhyay",
                      description:
                        "Rising sophomore at Rutgers University, double majoring in Computer Science and Data Science.",
                      avatar: "/images/avatars/aryan.png",
                    },
                    {
                      name: "Rohan Sada",
                      description:
                        "Pursuing a Master's degree in Electrical and Computer Engineering at Rutgers University, specializing in Machine Learning.",
                      avatar: "/images/avatars/rohan.png",
                    },
                    {
                      name: "Steven Huang",
                      description:
                        "Rising junior at Rutgers University, pursuing a B.S. in Electrical Engineering and a minor in Computer Science.",
                      avatar: "/images/avatars/steven.png",
                    },
                  ].map((member, index) => (
                    <div key={index} className="cityos-team-card">
                      <img
                        src={member.avatar}
                        alt={member.name}
                        className="cityos-team-avatar"
                        onError={(e) => {
                          e.target.src =
                            "https://placehold.co/400x400/27272a/fafafa?text=" +
                            member.name
                              .split(" ")
                              .map((n) => n[0])
                              .join("");
                        }}
                      />
                      <h3 className="cityos-team-name">{member.name}</h3>
                      <p className="cityos-team-desc">{member.description}</p>
                    </div>
                  ))}
                </div>
              </div>
            </section>

            <section className="cityos-documentation">
              <div className="cityos-documentation-container">
                <h2 id="doc" className="cityos-team-title">
                  Design Documentation Section
                </h2>
                <div className="images-container">
                  <div id="doc" className="paragraph-text-container">
                    <p id="doc" className="paragraph-header">
                      Overall Project Design Flowchart
                    </p>
                    <p id="doc" className="paragraph-text">
                      Our parking predictor consists of 5 main components which
                      are the following: the Data Collection, Video Processing,
                      Data Formatting, Prediction Modeling, and the User
                      Interface.
                    </p>
                    <p id="doc" className="paragraph-text">
                      The data collection is being done from the Rutger's Winlab
                      Camera which is pointed into the adjacent parking lot. It
                      collects video footage daily from 8 am to 8 pm.
                    </p>
                    <p id="doc" className="paragraph-text">
                      The video processing is where the video footage is
                      analyzed for information. In our case, it is checking each
                      of our 10 parking spots for availability. When a vehicle
                      parks into any of the spots, it will return data that this
                      spot has been occupied. We accomplished this functionality
                      using OpenCV and YOLOv8.
                    </p>
                    <p id="doc" className="paragraph-text">
                      The video formatting is where the video data formatted and
                      aggregated into a csv file. Within a line, it displays the
                      spotID number, Month, Day, Year, Hour, Minute, Second, and
                      the status of whether the spot is occupied or free.
                    </p>
                    <p id="doc" className="paragraph-text">
                      The prediction model is where the aggregated data is
                      imported in order to train and teach a machine learning
                      model. In our project, we are using a Random Forest model
                      which will take the data and use it to predict the
                      occupancy given a spotID and a time.
                    </p>
                    <p id="doc" className="paragraph-text">
                      The user interface is where people can interact with our
                      systems. We are planning to implement a large interactive
                      ui where users are able to see a mock replica of the
                      parking lot and are able to then select and visualize
                      parking lot occupancy through the days and weeks.
                    </p>
                  </div>
                  <img
                    id="doc"
                    className="images"
                    src="/assets/CityOS_design_flowchart.PNG"
                  />
                </div>
              </div>
              <div className="cityos-documentation-container">
                <div className="images-container">
                  <img
                    id="doc"
                    className="images"
                    src="/assets/VehicleDetection.png"
                  />
                  <div id="doc" className="paragraph-text-container">
                    <p id="doc" className="paragraph-header">
                      Video Detection, YOLOv8, and OpenCV
                    </p>
                    <p id="doc" className="paragraph-text">
                      The photo on the left is what the video processings
                      pipeline looks like. Inside of this photo, the occupied
                      spots are red while the free spots are green at this
                      moment of time. This process is done using OpenCV and
                      YOLOv8. YOLOv8 is specialized tool for object detection
                      and OpenCV is a computer vision library and general image
                      processing tool which backs up YOLO.
                    </p>
                    <p id="doc" className="paragraph-text">
                      This step of our project is critical to make as accurate
                      as possible as faulty data will lead to a faulty
                      prediction model and innacurate results.
                    </p>
                  </div>
                </div>
              </div>
            </section>

            <section className="cityos-timeline">
              <div className="cityos-timeline-all">
                <h2 className="cityos-timeline-title">Our Progress</h2>
                <div className="cityos-timeline-container">
                  <div className="cityos-timeline-left"></div>
                  <div className="cityos-timeline-list">
                    {[
                      {
                        week: "Week 1",
                        date: "May 27th, 2025",
                        accomplishments: [
                          "Met with Dr. Ortiz to define project scope.",
                          "Narrowed focus to a smart car parking system.",
                          "Began research into data regression models and project documentation.",
                        ],
                      },
                      {
                        week: "Week 2",
                        date: "June 2nd, 2025",
                        accomplishments: [
                          "Drafted the detailed system design document.",
                          "Obtained video feed of the parking lot and applied YOLOv8 for object detection.",
                          "Outlined the system architecture, including the Data Logger, ML Model Trainer, and Prediction API.",
                        ],
                      },
                      {
                        week: "Week 3",
                        date: "June 9th, 2025",
                        accomplishments: [
                          "Implemented and tested three initial ML models: Linear Regression, Naive Bayes, and Gradient Boosting.",
                          "Achieved initial prediction results on sample data.",
                          "Began learning about Decision Tree and Random Forest algorithms for future implementation.",
                        ],
                      },
                      {
                        week: "Week 4",
                        date: "June 16th 2025",
                        accomplishments: [
                          "Implemented and tested Decision Tree and Random Forest ML models.",
                          "Created this very website :D",
                          "Continued with data collection and aggregation for ML models.",
                        ],
                      },
                      {
                        week: "Week 5",
                        date: "June 23th 2025",
                        accomplishments: [
                          "Created the design documentation section of the website",
                          "Designed a mock up of the web app with components",
                          "Collected and imported more data as well as correcting some overfitting with the model",
                          "Ran RandomCV and GridsearchCV across multiple folds for optimization and cross-validation",
                          "Generated occupancy histograms per day to visualize trends in each lot",
                        ],
                      },
                      {
                        week: "Week 6",
                        date: "June 30th 2025",
                        accomplishments: [
                          "Created 3D model assets of vehicles for the web app",
                          "Generated occupancy graphs from the machine learning model",
                          "Continued collecting more data to train the model",
                        ],
                      },
                      {
                        week: "Week 7",
                        date: "July 7th 2025",
                        accomplishments: [
                          "Developed a finished rough layout of the parking web app and connected it to the website",
                          "Analyzed graphs outputted by the Random Forest's prediction and the actual camera detection of that day",
                          "Conceptualized an expansion of project utilizing more of the parking lot which requires a new detection model not based on bounding boxes or points",
                        ],
                      },
                      {
                        week: "Week 8",
                        date: "July 14th 2025",
                        accomplishments: [
                          "Began annotation and cropping of parking images used to train another YOLO detection model",
                          "Continued work on the web app: developed and laid out buttons and made this orbit website",
                          "Connected the prediction model to the old UI system",
                        ],
                      },
                      {
                        week: "Week 9",
                        date: "July 21th 2025",
                        accomplishments: [
                          "Trained the new YOLO detection model off of the cropped parking images and generated training and validation loss graphs",
                          "Continued developing functionality to the user interface: collecting user information and formatting the parking map",
                          "Created a script that takes a folder in the format YYYY-MM-DD based on today’s date and appends it to the master dataset for ML automation",
                        ],
                      },
                      {
                        week: "Week 10",
                        date: "July 28th 2025",
                        accomplishments: [
                          "Finalized the web app UI: fully connected the requests to the ML model and have it properly displayed back",
                          "Finalized the project poster and final presentation",
                          "Cried happy tears  :>",
                        ],
                      },
                    ].map((week, index) => (
                      <div key={index} className="cityos-timeline-card">
                        <div className="cityos-timeline-header">
                          <h3 className="cityos-timeline-week">{week.week}</h3>
                          <span className="cityos-timeline-date">
                            {week.date}
                          </span>
                        </div>
                        <ul className="cityos-timeline-ul">
                          {week.accomplishments.map((item, itemIndex) => (
                            <li key={itemIndex} className="cityos-timeline-li">
                              <span className="cityos-timeline-dot">•</span>
                              <span className="cityos-timeline-text">
                                {item}
                              </span>
                            </li>
                          ))}
                        </ul>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </section>
          </div>
        );

        // ================================================================================================//

        const PredictorPage = () => (
          <div className="cityos-predictor-main">
            <div className="cityos-predictor-container predictor-container-style">
              <div className="cityos-predictor-titlewrap">
                <h1 className="cityos-predictor-title">
                  Parking Availability Predictor
                </h1>
              </div>
              <div className="cityos-predictor-panel predictor-panel-style">
                <div className="cityos-predictor-fields">
                  <div>
                    <label htmlFor="spot-id" className="cityos-predictor-label">
                      Select Parking Spot
                    </label>
                    <select
                      id="spot-id"
                      value={spot}
                      onChange={(e) => setSpot(e.target.value)}
                      className="cityos-predictor-input predictor-input-style"
                      aria-label="Select Parking Spot"
                    >
                      <option value="spot_1">Spot 1</option>
                      <option value="spot_2">Spot 2</option>
                      <option value="spot_3">Spot 3</option>
                      <option value="spot_4">Spot 4</option>
                      <option value="spot_5">Spot 5</option>
                      <option value="spot_6">Spot 6</option>
                      <option value="spot_10">Spot 10</option>
                      <option value="spot_12">Spot 12</option>
                      <option value="spot_13">Spot 13</option>
                      <option value="spot_14">Spot 14</option>
                    </select>
                  </div>
                  <div>
                    <label htmlFor="day" className="cityos-predictor-label">
                      Select Day
                    </label>
                    <select
                      id="day"
                      value={day}
                      onChange={(e) => setDay(e.target.value)}
                      className="cityos-predictor-input predictor-input-style"
                      aria-label="Select Day"
                    >
                      <option value="Monday">Monday</option>
                      <option value="Tuesday">Tuesday</option>
                      <option value="Wednesday">Wednesday</option>
                      <option value="Thursday">Thursday</option>
                      <option value="Friday">Friday</option>
                      <option value="Saturday">Saturday</option>
                      <option value="Sunday">Sunday</option>
                    </select>
                  </div>
                  <div>
                    <label className="cityos-predictor-label">Enter Time</label>
                    <div className="time-input-container">
                      <label className="time-mode-label">
                        <input
                          type="radio"
                          name="timeMode"
                          value="manual"
                          checked={timeMode === "manual"}
                          onChange={() => setTimeMode("manual")}
                        />
                        Manual
                      </label>
                      <label className="time-mode-label">
                        <input
                          type="radio"
                          name="timeMode"
                          value="dropdown"
                          checked={timeMode === "dropdown"}
                          onChange={() => setTimeMode("dropdown")}
                        />
                        Dropdown
                      </label>
                    </div>
                    {timeMode === "manual" ? (
                      <input
                        type="time"
                        id="time"
                        value={time}
                        onChange={(e) => setTime(e.target.value)}
                        step="900"
                        className="cityos-predictor-input time-input"
                        aria-label="Enter Time"
                      />
                    ) : (
                      <select
                        id="time-dropdown"
                        value={time}
                        onChange={(e) => setTime(e.target.value)}
                        className="cityos-predictor-input time-input"
                        aria-label="Select Time"
                      >
                        <option value="">-- Select a time --</option>
                        {commonTimes.map((t) => (
                          <option key={t} value={t}>
                            {t}
                          </option>
                        ))}
                      </select>
                    )}
                    {time && (
                      <div
                        style={{
                          color: "#c7f361",
                          fontWeight: 600,
                          marginTop: "-0.5rem",
                          marginBottom: "0.5rem",
                          display: "flex",
                          alignItems: "center",
                          gap: "0.5rem",
                        }}
                      >
                        <svg
                          width="20"
                          height="20"
                          fill="#c7f361"
                          viewBox="0 0 20 20"
                        >
                          <path
                            fillRule="evenodd"
                            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                            clipRule="evenodd"
                          />
                        </svg>
                        Time entered!
                      </div>
                    )}
                  </div>
                  <button
                    onClick={handlePrediction}
                    className="cityos-btn cityos-btn-primary predict-btn-style"
                    type="button"
                    disabled={!time}
                    aria-label="Check Availability"
                  >
                    Check Availability
                  </button>
                  <div className="cityos-predictor-resultwrap">
                    {predictionResult ? (
                      <div
                        className={`cityos-predictor-result${
                          showResult ? " fade-in" : ""
                        } ${
                          predictionResult === "Free"
                            ? " cityos-predictor-result-free"
                            : " cityos-predictor-result-engaged"
                        }`}
                      >
                        {predictionResult === "Free" ? (
                          <svg
                            className="cityos-predictor-icon"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                          >
                            <path
                              fillRule="evenodd"
                              d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                              clipRule="evenodd"
                            />
                          </svg>
                        ) : (
                          <svg
                            className="cityos-predictor-icon"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                          >
                            <path
                              fillRule="evenodd"
                              d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                              clipRule="evenodd"
                            />
                          </svg>
                        )}
                        <span className="cityos-predictor-result-text">
                          Parking is {predictionResult}
                        </span>
                      </div>
                    ) : (
                      <p className="cityos-predictor-placeholder">
                        Enter a time to check parking availability
                      </p>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>
        );

        const MapPage = () => {
          const [mapSpot, setMapSpot] = useState("spot_1");
          const [mapDay, setMapDay] = useState("Monday");
          const [mapTime, setMapTime] = useState("07:00");
          const [mapTimeSlider, setMapTimeSlider] = useState(1);
          const [mapPredictionResult, setMapPredictionResult] = useState(null);
          const [selectedSpot, setSelectedSpot] = useState(null);
          const [occupiedSpots, setOccupiedSpots] = useState([
            "spot_3",
            "spot_7",
            "spot_15",
            "spot_22",
            "spot_28",
          ]);

          // Create parking spots data
          const parkingSpots = [];

          for (let row = 1; row <= 4; row++) {
            // First and last row → 4 spots, middle rows → 5 spots
            const spotsInRow = row === 1 || row === 4 ? 4 : 5;

            for (let pos = 1; pos <= spotsInRow; pos++) {
              const spotNumber = parkingSpots.length + 1; // Ensure sequential numbering
              parkingSpots.push({
                id: `spot_${spotNumber}`,
                row: row,
                position: pos,
                number: spotNumber,
              });
            }
          }

          const sliderMin = 7; // 7 AM
          const sliderMax = 19; // 7 PM

          // Helper: Convert slider (1–100) → time string
          const sliderToTime = (value) => {
            const hours = sliderMin + (value / 100) * (sliderMax - sliderMin);
            const hourStr = Math.floor(hours).toString().padStart(2, "0");
            const minStr = Math.round((hours % 1) * 60)
              .toString()
              .padStart(2, "0");
            return `${hourStr}:${minStr}`;
          };

          // Helper: Convert time string (HH:MM) → slider value (1–100)
          const timeToSlider = (timeStr) => {
            const [h, m] = timeStr.split(":").map(Number);
            const decimalHours = h + m / 60;
            const sliderVal =
              ((decimalHours - sliderMin) / (sliderMax - sliderMin)) * 100;
            return Math.min(100, Math.max(1, Math.round(sliderVal)));
          };

          // Synchronize slider → time input
          const handleSliderChange = (e) => {
            const sliderValue = parseInt(e.target.value);
            setMapTimeSlider(sliderValue);
            const syncedTime = sliderToTime(sliderValue);
            setMapTime(syncedTime);

            // Automatically check all spots when slider changes
            setTimeout(() => {
              handleBatchPrediction();
            }, 100); // Small delay to ensure state is updated
          };

          // Synchronize time input → slider
          const handleTimeChange = (e) => {
            const newTime = e.target.value;
            setMapTime(newTime);
            const sliderValue = timeToSlider(newTime);
            setMapTimeSlider(sliderValue);

            // Automatically check all spots when time input changes
            setTimeout(() => {
              handleBatchPrediction();
            }, 100); // Small delay to ensure state is updated
          };

          const handleSpotClick = (spotId, spotNumber) => {
            setSelectedSpot(spotId);
            setMapSpot(spotId);
          };

          const handleMapPrediction = async () => {
            const [hour, minute] = mapTime.split(":");

            try {
              const response = await fetch("/predict", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  spot_id: mapSpot,
                  day: mapDay,
                  hour: hour,
                  minute: minute,
                }),
              });

              if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
              }

              const data = await response.json();
              setMapPredictionResult(data.status);

              if (data.status === "Occupied") {
                setOccupiedSpots((prevSpots) =>
                  prevSpots.includes(mapSpot)
                    ? prevSpots
                    : [...prevSpots, mapSpot]
                );
              } else {
                setOccupiedSpots((prevSpots) =>
                  prevSpots.filter((spotId) => spotId !== mapSpot)
                );
              }

              // Automatically predict timeline after getting current status
              await predictNextStatusChange();
            } catch (error) {
              console.error("Prediction error:", error);
              alert(
                "Error getting prediction. Please make sure the ML server is running."
              );
            }
          };

          const handleBatchPrediction = async () => {
            const [hour, minute] = mapTime.split(":");
            const allSpotIds = parkingSpots.map((spot) => spot.id);

            try {
              const response = await fetch("/predict_batch", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  spot_ids: allSpotIds,
                  day: mapDay,
                  hour: hour,
                  minute: minute,
                }),
              });

              if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
              }

              const data = await response.json();

              // Update occupied spots based on batch predictions
              const occupiedSpotIds = Object.keys(data).filter(
                (spotId) => data[spotId].status === "Occupied"
              );
              setOccupiedSpots(occupiedSpotIds);

              // Clear individual prediction result since we're showing all spots
              setMapPredictionResult(null);

              console.log(
                `Updated map with ${occupiedSpotIds.length} occupied spots out of ${allSpotIds.length} total spots`
              );
            } catch (error) {
              console.error("Batch prediction error:", error);
              alert(
                "Error getting batch predictions. Please make sure the ML server is running."
              );
            }
          };

          const [nextStatusTime, setNextStatusTime] = useState(null);

          const predictNextStatusChange = async () => {
            if (!selectedSpot) return;

            const [currentHour, currentMinute] = mapTime.split(":");
            const currentTime =
              parseInt(currentHour) * 60 + parseInt(currentMinute);

            // Check next 12 hours (every 30 minutes)
            const timeSlots = [];
            for (let i = 1; i <= 24; i++) {
              const futureTime = currentTime + i * 30;
              const futureHour = Math.floor(futureTime / 60) % 24;
              const futureMinute = futureTime % 60;
              timeSlots.push({
                hour: futureHour.toString().padStart(2, "0"),
                minute: futureMinute.toString().padStart(2, "0"),
              });
            }

            try {
              // Get current status
              const currentResponse = await fetch("/predict", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  spot_id: selectedSpot,
                  day: mapDay,
                  hour: currentHour,
                  minute: currentMinute,
                }),
              });

              if (!currentResponse.ok)
                throw new Error("Failed to get current status");
              const currentData = await currentResponse.json();
              const currentStatus = currentData.status;

              // Check each future time slot
              for (const timeSlot of timeSlots) {
                const response = await fetch("/predict", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    spot_id: selectedSpot,
                    day: mapDay,
                    hour: timeSlot.hour,
                    minute: timeSlot.minute,
                  }),
                });

                if (!response.ok) continue;
                const data = await response.json();

                if (data.status !== currentStatus) {
                  setNextStatusTime({
                    time: `${timeSlot.hour}:${timeSlot.minute}`,
                    newStatus: data.status,
                    currentStatus: currentStatus,
                  });
                  return;
                }
              }

              setNextStatusTime({
                time: "No change in next 12 hours",
                newStatus: null,
                currentStatus: currentStatus,
              });
            } catch (error) {
              console.error("Error predicting next status change:", error);
              setNextStatusTime(null);
            }
          };

          const getSpotStyle = (spot) => {
            const isSelected = selectedSpot === spot.id;
            const isOccupied = occupiedSpots.includes(spot.id);

            let backgroundColor = "rgba(199, 243, 97, 0.1)";
            let borderColor = "#c4f1c4";
            let color = "#14222b";

            if (isSelected) {
              backgroundColor = "rgba(199, 243, 97, 0.95)";
              borderColor = "#fffed0";
            } else if (isOccupied) {
              backgroundColor = "rgba(239, 68, 68, 0.8)";
              borderColor = "#ef4444";
              color = "white";
            }

            return {
              flex: 1,
              height: "100%",
              border: `1px solid ${borderColor}`,
              backgroundColor: backgroundColor,
              cursor: isOccupied ? "not-allowed" : "pointer",
              transition: "all 0.3s ease",
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
              fontSize: "8px",
              fontWeight: "bold",
              color: color,
              borderRadius: "1px",
              fontFamily: "Inter, sans-serif",
              minWidth: "15px",
              position: "relative",
              zIndex: isSelected ? 10 : 5,
            };
          };

          return (
            <div className="map-page-container">
              <div className="map-page-content">
                {/* Header Controls */}
                <div className="map-header">
                  <div
                    style={{
                      display: "flex",
                      alignItems: "center",
                      gap: "0.5rem",
                    }}
                  >
                    <span
                      style={{
                        color: "#fffed0",
                        fontWeight: "600",
                        fontSize: "14px",
                      }}
                    >
                      Spot:
                    </span>
                    <select
                      value={mapSpot}
                      onChange={(e) => setMapSpot(e.target.value)}
                      style={{
                        padding: "0.5rem",
                        borderRadius: "0.375rem",
                        border: "2px solid #c4f1c4",
                        backgroundColor: "rgba(15, 23, 42, 0.8)",
                        color: "#c4f1c4",
                        fontFamily: "Inter, sans-serif",
                        fontSize: "14px",
                      }}
                    >
                      {parkingSpots.map((spot) => (
                        <option key={spot.id} value={spot.id}>
                          Spot {spot.number}
                        </option>
                      ))}
                    </select>
                  </div>

                  <div
                    style={{
                      display: "flex",
                      alignItems: "center",
                      gap: "0.5rem",
                    }}
                  >
                    <span
                      style={{
                        color: "#fffed0",
                        fontWeight: "600",
                        fontSize: "14px",
                      }}
                    >
                      Day:
                    </span>
                    <select
                      value={mapDay}
                      onChange={(e) => setMapDay(e.target.value)}
                      style={{
                        padding: "0.5rem",
                        borderRadius: "0.375rem",
                        border: "2px solid #c4f1c4",
                        backgroundColor: "rgba(15, 23, 42, 0.8)",
                        color: "#c4f1c4",
                        fontFamily: "Inter, sans-serif",
                        fontSize: "14px",
                      }}
                    >
                      <option value="Monday">Monday</option>
                      <option value="Tuesday">Tuesday</option>
                      <option value="Wednesday">Wednesday</option>
                      <option value="Thursday">Thursday</option>
                      <option value="Friday">Friday</option>
                      <option value="Saturday">Saturday</option>
                      <option value="Sunday">Sunday</option>
                    </select>
                  </div>

                  <div
                    style={{
                      display: "flex",
                      alignItems: "center",
                      gap: "0.5rem",
                    }}
                  >
                    <span
                      style={{
                        color: "#fffed0",
                        fontWeight: "600",
                        fontSize: "14px",
                      }}
                    >
                      Time:
                    </span>
                    <input
                      type="time"
                      value={mapTime}
                      onChange={handleTimeChange}
                      step="900"
                      min="07:00"
                      max="19:00"
                      style={{
                        padding: "0.5rem",
                        borderRadius: "0.375rem",
                        border: "2px solid #c4f1c4",
                        backgroundColor: "rgba(15, 23, 42, 0.8)",
                        color: "#c4f1c4",
                        fontFamily: "Inter, sans-serif",
                        fontSize: "14px",
                      }}
                    />
                  </div>

                  <div
                    style={{
                      flex: 1,
                      padding: "0 1rem",
                      maxWidth: "400px",
                      display: "flex",
                      flexDirection: "column",
                      gap: "0.25rem",
                    }}
                  >
                    <span
                      style={{
                        color: "#fffed0",
                        fontWeight: "600",
                        fontSize: "14px",
                      }}
                    >
                      Time Slider:
                    </span>
                    <input
                      type="range"
                      min="1"
                      max="100"
                      value={mapTimeSlider}
                      onChange={handleSliderChange}
                      style={{
                        width: "100%",
                        height: "8px",
                        borderRadius: "4px",
                        background: "rgba(196, 241, 196, 0.3)",
                        outline: "none",
                        WebkitAppearance: "none",
                      }}
                    />
                  </div>

                  <button
                    onClick={handleMapPrediction}
                    style={{
                      padding: "0.5rem 1rem",
                      background: "#c7f361",
                      color: "#14222b",
                      border: "none",
                      borderRadius: "6px",
                      fontWeight: "600",
                      fontFamily: "Inter, sans-serif",
                      cursor: "pointer",
                      fontSize: "14px",
                      marginRight: "0.5rem",
                    }}
                  >
                    Check Spot
                  </button>

                  {mapPredictionResult && (
                    <div
                      style={{
                        padding: "0.5rem 1rem",
                        backgroundColor:
                          mapPredictionResult === "Free"
                            ? "#10b981"
                            : "#ef4444",
                        color: "white",
                        borderRadius: "0.375rem",
                        fontWeight: "bold",
                      }}
                    >
                      {mapPredictionResult}
                    </div>
                  )}
                </div>

                {/* Side Bar */}
                <div
                  style={{
                    position: "fixed",
                    top: "7.5rem",
                    left: 0,
                    bottom: 0,
                    width: "30%",
                    background: "#0a5a4193",
                    backdropFilter: "blur(2px)",
                    borderRight: "3px solid #fffed0",
                    padding: "1rem",
                    zIndex: 5,
                  }}
                >
                  <h3
                    style={{
                      margin: "0 0 1.5rem 0",
                      color: "#fffed0",
                      fontSize: "24px",
                      fontWeight: "bold",
                      borderBottom: "3px solid #c7f361",
                      paddingBottom: "0.75rem",
                      textAlign: "center",
                      textShadow: "0 2px 4px rgba(0,0,0,0.3)",
                      letterSpacing: "1px",
                    }}
                  >
                    Parking Information
                  </h3>
                  {/* Combined Parking Information and Status */}
                  <div
                    style={{
                      border: "3px solid #c7f361",
                      padding: "1.5rem",
                      borderRadius: "12px",
                      backgroundColor: "rgba(199, 243, 97, 0.08)",
                      boxShadow:
                        "0 8px 32px rgba(199, 243, 97, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.1)",
                      backdropFilter: "blur(10px)",
                    }}
                  >
                    <h4
                      style={{
                        margin: "0 0 1rem 0",
                        color: "#fffed0",
                        fontSize: "20px",
                        fontWeight: "bold",
                        borderBottom: "2px solid #c7f361",
                        paddingBottom: "0.5rem",
                        textAlign: "center",
                        textShadow: "0 2px 4px rgba(0,0,0,0.3)",
                        letterSpacing: "0.5px",
                      }}
                    >
                      Status
                    </h4>

                    <p
                      style={{
                        margin: "1rem 0",
                        fontSize: "18px",
                        color: "#c4f1c4",
                        lineHeight: "1.6",
                        padding: "0.75rem",
                        backgroundColor: "rgba(199, 243, 97, 0.05)",
                        borderRadius: "8px",
                        border: "1px solid rgba(199, 243, 97, 0.2)",
                      }}
                    >
                      <span style={{ fontWeight: "600", color: "#fffed0" }}>
                        Spot:
                      </span>{" "}
                      <span
                        style={{
                          fontWeight: "bold",
                          color: "#c7f361",
                          fontSize: "20px",
                          textShadow: "0 1px 2px rgba(0,0,0,0.3)",
                        }}
                      >
                        {mapSpot === "spot_1" ? "None" : mapSpot}
                      </span>
                    </p>

                    {nextStatusTime ? (
                      <div>
                        <p
                          style={{
                            margin: "1rem 0",
                            fontSize: "16px",
                            color: "#c4f1c4",
                            lineHeight: "1.6",
                            padding: "0.75rem",
                            backgroundColor: "rgba(199, 243, 97, 0.05)",
                            borderRadius: "8px",
                            border: "1px solid rgba(199, 243, 97, 0.2)",
                          }}
                        >
                          <span style={{ fontWeight: "600", color: "#fffed0" }}>
                            Next Change:
                          </span>{" "}
                          <span
                            style={{
                              fontWeight: "bold",
                              color: "#c7f361",
                              fontSize: "18px",
                              textShadow: "0 1px 2px rgba(0,0,0,0.3)",
                            }}
                          >
                            {nextStatusTime.time}
                          </span>
                        </p>
                        {nextStatusTime.newStatus && (
                          <p
                            style={{
                              margin: "1rem 0",
                              fontSize: "16px",
                              color: "#c4f1c4",
                              lineHeight: "1.6",
                              padding: "0.75rem",
                              backgroundColor: "rgba(199, 243, 97, 0.05)",
                              borderRadius: "8px",
                              border: "1px solid rgba(199, 243, 97, 0.2)",
                            }}
                          >
                            <span
                              style={{ fontWeight: "600", color: "#fffed0" }}
                            >
                              Will Become:
                            </span>{" "}
                            <span
                              style={{
                                fontWeight: "bold",
                                fontSize: "18px",
                                color:
                                  nextStatusTime.newStatus === "Free"
                                    ? "#10b981"
                                    : "#ef4444",
                                textShadow: "0 1px 2px rgba(0,0,0,0.3)",
                              }}
                            >
                              {nextStatusTime.newStatus}
                            </span>
                          </p>
                        )}
                      </div>
                    ) : (
                      <p
                        style={{
                          margin: "1rem 0",
                          fontSize: "16px",
                          color: "#c4f1c4",
                          fontStyle: "italic",
                          textAlign: "center",
                          padding: "1rem",
                          backgroundColor: "rgba(199, 243, 97, 0.05)",
                          borderRadius: "8px",
                          border: "1px solid rgba(199, 243, 97, 0.2)",
                        }}
                      >
                        Click "Check Spot" to see timeline
                      </p>
                    )}
                  </div>
                </div>

                {/* Map Area */}
                <div
                  style={{
                    position: "absolute",
                    top: "7.5rem",
                    left: "30%",
                    right: 0,
                    bottom: 0,
                    overflow: "hidden",
                    zIndex: 0,
                  }}
                >
                  <div
                    style={{
                      width: "100%",
                      height: "100%",
                      position: "relative",
                    }}
                  >
                    <img
                      src="/assets/CityOSMap.png"
                      alt="CityOS Parking Lot Map"
                      style={{
                        width: "100%",
                        height: "100%",
                        objectFit: "contain",
                        objectPosition: "center",
                      }}
                    />

                    {/* Interactive Parking Spots */}
                    {/* Row 1 */}
                    <div
                      style={{
                        position: "absolute",
                        top: "9.32%",
                        left: "44.3%",
                        width: "17.3%",
                        height: "11%",
                        gap: "2%",
                        display: "flex",

                        zIndex: 5,
                      }}
                    >
                      {parkingSpots
                        .filter((spot) => spot.row === 1)
                        .map((spot) => (
                          <div
                            key={spot.id}
                            style={getSpotStyle(spot)}
                            onClick={() =>
                              !occupiedSpots.includes(spot.id) &&
                              handleSpotClick(spot.id, spot.number)
                            }
                            title={`Parking Spot ${spot.number}`}
                          >
                            {occupiedSpots.includes(spot.id)
                              ? "OCC"
                              : spot.number}
                          </div>
                        ))}
                    </div>

                    {/* Row 2 */}
                    <div
                      style={{
                        position: "absolute",
                        top: "36.9%",
                        left: "41.35%",
                        width: "21.55%",
                        height: "10%",
                        display: "flex",
                        gap: "2.6%",
                        zIndex: 5,
                      }}
                    >
                      {parkingSpots
                        .filter((spot) => spot.row === 2)
                        .map((spot) => (
                          <div
                            key={spot.id}
                            style={getSpotStyle(spot)}
                            onClick={() =>
                              !occupiedSpots.includes(spot.id) &&
                              handleSpotClick(spot.id, spot.number)
                            }
                            title={`Parking Spot ${spot.number}`}
                          >
                            {occupiedSpots.includes(spot.id)
                              ? "OCC"
                              : spot.number}
                          </div>
                        ))}
                    </div>

                    {/* Row 3 */}
                    <div
                      style={{
                        position: "absolute",
                        top: "48.2%",
                        left: "41.35%",
                        width: "21.55%",
                        height: "10%",
                        display: "flex",
                        gap: "2.6%",
                        zIndex: 5,
                      }}
                    >
                      {parkingSpots
                        .filter((spot) => spot.row === 3)
                        .map((spot) => (
                          <div
                            key={spot.id}
                            style={getSpotStyle(spot)}
                            onClick={() =>
                              !occupiedSpots.includes(spot.id) &&
                              handleSpotClick(spot.id, spot.number)
                            }
                            title={`Parking Spot ${spot.number}`}
                          >
                            {occupiedSpots.includes(spot.id)
                              ? "OCC"
                              : spot.number}
                          </div>
                        ))}
                    </div>

                    {/* Row 4 */}
                    <div
                      style={{
                        position: "absolute",
                        top: "77.8%",
                        left: "53.2%",
                        width: "16.5%",
                        height: "11%",
                        gap: "4%",
                        display: "flex",

                        zIndex: 5,
                      }}
                    >
                      {parkingSpots
                        .filter((spot) => spot.row === 4)
                        .map((spot) => (
                          <div
                            key={spot.id}
                            style={getSpotStyle(spot)}
                            onClick={() =>
                              !occupiedSpots.includes(spot.id) &&
                              handleSpotClick(spot.id, spot.number)
                            }
                            title={`Parking Spot ${spot.number}`}
                          >
                            {occupiedSpots.includes(spot.id)
                              ? "OCC"
                              : spot.number}
                          </div>
                        ))}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        return (
          <div className="cityos-app">
            <div className="background">
              <Header />
              {currentPage === "about" ? (
                <AboutPage />
              ) : currentPage === "predictor" ? (
                <PredictorPage />
              ) : (
                <MapPage />
              )}
            </div>
          </div>
        );
      }
      ReactDOM.render(<App />, document.getElementById("root"));
    </script>
    {% endraw %}
  </body>
</html>
